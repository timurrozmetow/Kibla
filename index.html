<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Кибла — направление на Каабу</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: grid;
      place-items: center;
      min-height: 100vh;
      padding: 16px;
    }
    .card {
      width: min(520px, 100%);
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.08);
    }
    h1 { font-size: 18px; margin: 0 0 8px; }
    .muted { opacity: .75; font-size: 13px; line-height: 1.35; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button, input {
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.35);
      padding: 10px 12px;
      font-size: 14px;
      background: transparent;
      color: inherit;
    }
    button { cursor: pointer; }
    button.primary { border-color: rgba(80,160,255,.7); }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
    .grid2 input { width: 100%; box-sizing: border-box; }
    .dial {
      margin: 18px auto 10px;
      width: 260px;
      height: 260px;
      border-radius: 50%;
      border: 1px solid rgba(127,127,127,.35);
      position: relative;
      display: grid;
      place-items: center;
      user-select: none;
      touch-action: manipulation;
    }
    .n {
      position: absolute; top: 10px; left: 50%;
      transform: translateX(-50%);
      font-weight: 700; font-size: 14px;
      opacity: .85;
    }
    .arrowWrap {
      width: 180px; height: 180px;
      display: grid; place-items: center;
      transform: rotate(0deg);
      transition: transform .10s linear;
    }
    .arrow {
      width: 0; height: 0;
      border-left: 16px solid transparent;
      border-right: 16px solid transparent;
      border-bottom: 70px solid currentColor;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.15));
    }
    .info {
      margin-top: 10px;
      display: grid;
      gap: 6px;
      font-size: 14px;
    }
    .kv {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px dashed rgba(127,127,127,.25);
      padding-bottom: 6px;
    }
    .kv b { font-weight: 650; }
    .status {
      margin-top: 10px;
      font-size: 13px;
      opacity: .85;
      line-height: 1.35;
    }
    .tiny { font-size: 12px; opacity: .7; margin-top: 8px; }
    .switchRow {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      opacity: .9;
    }
    .switchRow input { transform: scale(1.1); }
    .badge {
      font-size: 12px;
      padding: 2px 8px;
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 999px;
      opacity: .9;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Направление на Каабу (Кибла)</h1>
    <div class="muted">
      Лёгкая версия без карт. Для точного “Авто” нужны GPS и компас.
      На Android компас в браузере иногда “инвертирован” — для этого есть переключатель ниже.
    </div>

    <div class="dial" aria-label="Компас">
      <div class="n">N</div>
      <div id="arrowWrap" class="arrowWrap" title="Стрелка указывает на Киблу">
        <div class="arrow"></div>
      </div>
    </div>

    <div class="info">
      <div class="kv"><span>Азимут Киблы</span><b id="qiblaAz">—</b></div>
      <div class="kv"><span>Твой курс (компас)</span><b id="heading">—</b></div>
      <div class="kv"><span>Поворот стрелки</span><b id="turn">—</b></div>
      <div class="kv"><span>Координаты</span><b id="coords">—</b></div>
      <div class="kv"><span>Точность GPS</span><b id="acc">—</b></div>
    </div>

    <div class="row">
      <button class="primary" id="btnAuto">Авто: GPS + компас</button>
      <button id="btnGPS">Только GPS (без компаса)</button>
      <button id="btnStop">Стоп (отключить датчики)</button>
    </div>

    <div class="switchRow">
      <label style="display:flex;align-items:center;gap:8px;">
        <input type="checkbox" id="invert" />
        Инвертировать компас (если показывает “в другую сторону”)
      </label>
      <span class="badge" id="compassBadge">компас: off</span>
    </div>

    <div class="row">
      <button id="btnManual">Ручной ввод</button>
    </div>

    <div id="manualBox" style="display:none; margin-top:12px;">
      <div class="grid2">
        <input id="lat" inputmode="decimal" placeholder="Широта (например 37.9838)" />
        <input id="lon" inputmode="decimal" placeholder="Долгота (например 23.7275)" />
      </div>
      <div class="row">
        <button class="primary" id="btnCalc">Посчитать Киблу</button>
        <button id="btnUseSaved">Подставить сохранённые</button>
      </div>
      <div class="tiny">
        Координаты можно взять из Google Maps (долгое нажатие → копировать).
      </div>
    </div>

    <div class="status" id="status">Статус: ждём действия.</div>
    <div class="tiny">
      Для точности: убери магнитный чехол/держатель, отойди от машины/металла, сделай “восьмёрку” телефоном 5–10 секунд.
    </div>
  </div>

<script>
(() => {
  // Координаты Каабы
  const KAABA = { lat: 21.422487, lon: 39.826206 };

  const el = (id) => document.getElementById(id);
  const arrowWrap = el('arrowWrap');
  const statusEl = el('status');
  const qiblaAzEl = el('qiblaAz');
  const headingEl = el('heading');
  const turnEl = el('turn');
  const coordsEl = el('coords');
  const accEl = el('acc');
  const manualBox = el('manualBox');
  const invertEl = el('invert');
  const compassBadge = el('compassBadge');

  let userLat = null, userLon = null, gpsAcc = null;
  let headingDeg = null;   // 0..360 (0=N)
  let qiblaAz = null;      // 0..360
  let compassOn = false;

  // safe storage
  const storage = {
    get(key) {
      try { return localStorage.getItem(key); } catch { return null; }
    },
    set(key, val) {
      try { localStorage.setItem(key, val); } catch {}
    }
  };

  // Helpers
  const toRad = (d) => d * Math.PI / 180;
  const toDeg = (r) => r * 180 / Math.PI;
  const norm360 = (d) => ((d % 360) + 360) % 360;

  function setStatus(msg) { statusEl.textContent = 'Статус: ' + msg; }

  function getScreenAngle() {
    const so = window.screen?.orientation?.angle;
    if (typeof so === 'number') return so;
    const wo = window.orientation;
    if (typeof wo === 'number') return wo;
    return 0;
  }

  // сглаживание по короткой дуге (устойчивее)
  function smoothAngle(prev, next, alpha = 0.18) {
    if (prev == null) return next;
    let delta = ((next - prev + 540) % 360) - 180;
    return norm360(prev + delta * alpha);
  }

  function calcQiblaAzimuth(lat, lon) {
    const φ1 = toRad(lat);
    const φ2 = toRad(KAABA.lat);
    const Δλ = toRad(KAABA.lon - lon);

    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
    const θ = Math.atan2(y, x);
    return norm360(toDeg(θ));
  }

  function updateUI() {
    if (userLat != null && userLon != null) {
      coordsEl.textContent = `${userLat.toFixed(6)}, ${userLon.toFixed(6)}`;
      qiblaAz = calcQiblaAzimuth(userLat, userLon);
      qiblaAzEl.textContent = `${qiblaAz.toFixed(1)}°`;
      storage.set('qibla_lat', String(userLat));
      storage.set('qibla_lon', String(userLon));
    } else {
      coordsEl.textContent = '—';
      qiblaAzEl.textContent = '—';
      qiblaAz = null;
    }

    accEl.textContent = (gpsAcc == null) ? '—' : `${Math.round(gpsAcc)} м`;

    headingEl.textContent = (headingDeg == null) ? '—' : `${norm360(headingDeg).toFixed(1)}°`;

    if (qiblaAz != null) {
      const rotateDeg = (headingDeg == null) ? qiblaAz : norm360(qiblaAz - headingDeg);
      arrowWrap.style.transform = `rotate(${rotateDeg}deg)`;
      turnEl.textContent = `${rotateDeg.toFixed(1)}°`;
    } else {
      arrowWrap.style.transform = 'rotate(0deg)';
      turnEl.textContent = '—';
    }

    compassBadge.textContent = 'компас: ' + (compassOn ? 'on' : 'off');
  }

  // GPS
  function getGPS() {
    return new Promise((resolve) => {
      if (!navigator.geolocation) {
        setStatus('геолокация недоступна в этом браузере.');
        return resolve(false);
      }
      setStatus('запрашиваю GPS…');
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLat = pos.coords.latitude;
          userLon = pos.coords.longitude;
          gpsAcc = pos.coords.accuracy;
          setStatus('GPS получен.');
          updateUI();
          resolve(true);
        },
        (err) => {
          setStatus('ошибка GPS: ' + (err.message || err.code));
          resolve(false);
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 2000 }
      );
    });
  }

  // Compass handlers
  function onOrientationFixed(event) {
    let hd = null;

    // iOS Safari
    if (typeof event.webkitCompassHeading === 'number') {
      hd = event.webkitCompassHeading; // already 0..360, 0=N
    }
    // Android / Chrome
    else if (typeof event.alpha === 'number') {
      // default for many Android devices: heading ≈ 360 - alpha
      hd = invertEl.checked ? event.alpha : (360 - event.alpha);
      hd = hd + getScreenAngle();
    }

    if (hd == null) return;

    hd = norm360(hd);
    headingDeg = smoothAngle(headingDeg, hd, 0.20);
    updateUI();
  }

  async function requestCompass() {
    const DO = window.DeviceOrientationEvent;
    if (!DO) {
      setStatus('компас недоступен: нет DeviceOrientationEvent.');
      compassOn = false;
      updateUI();
      return false;
    }

    // iOS permission
    if (typeof DO.requestPermission === 'function') {
      try {
        const res = await DO.requestPermission();
        if (res !== 'granted') {
          setStatus('доступ к компасу не разрешён.');
          compassOn = false;
          updateUI();
          return false;
        }
      } catch {
        setStatus('не удалось запросить доступ к компасу.');
        compassOn = false;
        updateUI();
        return false;
      }
    }

    // remove previous to avoid duplicates
    window.removeEventListener('deviceorientationabsolute', onOrientationFixed, true);
    window.removeEventListener('deviceorientation', onOrientationFixed, true);

    window.addEventListener('deviceorientationabsolute', onOrientationFixed, true);
    window.addEventListener('deviceorientation', onOrientationFixed, true);

    compassOn = true;
    setStatus('компас включён.');
    updateUI();
    return true;
  }

  function stopSensors() {
    window.removeEventListener('deviceorientationabsolute', onOrientationFixed, true);
    window.removeEventListener('deviceorientation', onOrientationFixed, true);
    compassOn = false;
    headingDeg = null;
    setStatus('датчики отключены.');
    updateUI();
  }

  // Buttons
  el('btnAuto').addEventListener('click', async () => {
    manualBox.style.display = 'none';
    await getGPS();
    await requestCompass();
    updateUI();
    setStatus('режим Авто активен. Если стрелка “зеркально” — включи инверсию.');
  });

  el('btnGPS').addEventListener('click', async () => {
    manualBox.style.display = 'none';
    stopSensors(); // выключаем компас
    await getGPS();
    updateUI();
    setStatus('режим: только GPS. Стрелка показывает азимут Киблы (без ориентации телефона).');
  });

  el('btnStop').addEventListener('click', () => {
    manualBox.style.display = 'none';
    stopSensors();
  });

  el('btnManual').addEventListener('click', () => {
    manualBox.style.display = (manualBox.style.display === 'none') ? 'block' : 'none';
    setStatus('ручной ввод: введи широту/долготу и нажми "Посчитать".');
  });

  el('btnUseSaved').addEventListener('click', () => {
    const slat = storage.get('qibla_lat');
    const slon = storage.get('qibla_lon');
    if (slat && slon) {
      el('lat').value = slat;
      el('lon').value = slon;
      setStatus('подставил сохранённые координаты.');
    } else {
      setStatus('сохранённых координат нет.');
    }
  });

  el('btnCalc').addEventListener('click', () => {
    const lat = parseFloat(el('lat').value.replace(',', '.'));
    const lon = parseFloat(el('lon').value.replace(',', '.'));
    if (!Number.isFinite(lat) || !Number.isFinite(lon) || Math.abs(lat) > 90 || Math.abs(lon) > 180) {
      setStatus('неверные координаты. Пример: 37.9838 и 23.7275');
      return;
    }
    userLat = lat;
    userLon = lon;
    gpsAcc = null;
    updateUI();
    setStatus('Кибла рассчитана по введённым координатам.');
  });

  invertEl.addEventListener('change', () => {
    // сразу обновим, чтобы увидеть эффект
    setStatus('инверсия изменена. Проверь совпадение с Muslim Pro.');
    updateUI();
  });

  // Init from storage
  const slat = storage.get('qibla_lat');
  const slon = storage.get('qibla_lon');
  if (slat && slon) {
    userLat = parseFloat(slat);
    userLon = parseFloat(slon);
  }
  updateUI();
})();
</script>
</body>
</html>